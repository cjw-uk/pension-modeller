<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Pension Forecast Calculator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <!-- Custom Font Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Helvetica', 'sans-serif'],
                    },
                    colors: {
                        'gem-blue': {
                            100: '#e0f3ff',
                            300: '#7bc4ff',
                            500: '#007bff',
                            700: '#0056b3',
                            900: '#002c5a',
                        },
                    },
                },
            },
        };
    </script>

    <!-- Custom Styles -->
    <style>
        /* Custom styles */
        body {
            font-family: 'Helvetica', 'sans-serif';
            overscroll-behavior: none;
        }

        /* Custom slider track */
        input[type="range"]::-webkit-slider-runnable-track {
            background: #e5e7eb; /* bg-gray-200 */
            height: 8px;
            border-radius: 9999px; /* rounded-full */
        }
        input[type="range"]::-moz-range-track {
            background: #e5e7eb; /* bg-gray-200 */
            height: 8px;
            border-radius: 9999px; /* rounded-full */
        }
        
        /* Custom slider thumb */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #007bff; /* gem-blue-500 */
            border-radius: 50%;
            cursor: pointer;
            margin-top: -6px; /* Center thumb */
            transition: background 0.2s;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #007bff; /* gem-blue-500 */
            border-radius: 50%;
            cursor: pointer;
            border: 0;
            transition: background 0.2s;
        }

        input[type="range"]:hover::-webkit-slider-thumb {
            background: #0056b3; /* gem-blue-700 */
        }
        input[type="range"]:hover::-moz-range-thumb {
            background: #0056b3; /* gem-blue-700 */
        }

        /* Checkbox styling */
        input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            background-color: #e5e7eb; /* bg-gray-200 */
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            transition: background-color 0.2s;
        }
        input[type="checkbox"]:checked {
            background-color: #007bff; /* gem-blue-500 */
        }
        input[type="checkbox"]:checked::after {
            content: '✓'; /* Checkmark */
            font-size: 14px;
            color: white;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }
        input[type="checkbox"]:hover {
            background-color: #d1d5db; /* bg-gray-300 */
        }
        input[type="checkbox"]:checked:hover {
            background-color: #0056b3; /* gem-blue-700 */
        }

        /* Custom input fields */
        .value-input {
            width: 100px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 6px 10px;
            text-align: right;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .value-input:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.2);
            outline: none;
        }
        
        /* Table styles */
        .plan-table th, .plan-table td {
            padding: 10px 12px;
            border: 1px solid #e5e7eb;
            text-align: left;
        }
        .plan-table th {
            background-color: #f9fafb; /* bg-gray-50 */
            font-weight: 600;
        }
        .plan-table input[type="number"] {
            width: 100px;
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
        }
        .plan-table input[type="number"]:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.2);
            outline: none;
        }
        
        /* Modal styles */
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
            max-width: 600px;
            max-height: 90vh;
        }
        
        /* Loading overlay */
        #loading-overlay {
            z-index: 49; /* Just below modal */
            transition: opacity 0.3s ease;
        }
        
        /* Advanced settings toggle */
        #advanced-assumptions-toggle::after {
            content: '▼'; /* Down arrow */
            display: inline-block;
            margin-left: 8px;
            transition: transform 0.2s;
            font-size: 0.7em;
        }
        #advanced-assumptions-toggle[aria-expanded="true"]::after {
            transform: rotate(180deg); /* Up arrow */
        }

    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8 min-h-screen antialiased">

    <!-- Welcome Modal -->
    <div id="welcome-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-xl shadow-2xl p-6 md:p-8 w-full transform scale-95 opacity-0 overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Welcome to Your Pension Calculator</h2>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-700 text-3xl">&times;</button>
            </div>
            <p class="text-gray-600 mb-4">This tool helps you forecast your pension pot and retirement income using a powerful Monte Carlo simulation.</p>
            
            <h3 class="text-lg font-semibold text-gem-blue-700 mt-5 mb-2">How It Works (Step-by-Step):</h3>
            
            <ol class="list-decimal list-inside text-gray-700 space-y-3">
                <li>
                    <strong>Set Your Basics:</strong> Use the sliders on the left for your "Current Age," "Retirement Age," and initial investments.
                </li>
                <li>
                    <strong>Check State Pension:</strong> If you want to include it, check the box and set the amount and start age.
                </li>
                <li>
                    <strong>Enable Monte Carlo (Recommended):</strong>
                    <ul class="list-disc list-inside ml-6 mt-2 space-y-2 text-sm text-gray-600">
                        <li>This runs 1,000 simulations to model market volatility.</li>
                        <li>Set your **Stock/Bond Allocation** and **Annual Investment Fee**.</li>
                        <li>Enable **"Adjust withdrawals for inflation"** for the most realistic plan.</li>
                        <li>(Optional) Open "Advanced Asset Assumptions" to fine-tune the model's engine.</li>
                    </ul>
                </li>
                <li>
                    <strong>Read the Graph:</strong>
                    <ul class="list-disc list-inside ml-6 mt-2 space-y-2 text-sm text-gray-600">
                        <li>The **solid black line** is the "median" (50th percentile or most likely) outcome.</li>
                        <li>The **shaded blue area** shows the 10th-90th percentile range—this is your "volatility band." The bottom line is a "poor" outcome.</li>
                    </ul>
                </li>
                <li>
                    <strong>Check Your "Plan Success Rate":</strong> This is your key metric. It shows the % of simulations where your money lasted until age 100.
                </li>
                 <li>
                    <strong>Customize Your Plan:</strong> Use the table at the bottom to set specific contribution or withdrawal amounts for any given year.
                </li>
            </ol>
            
            <button id="get-started-btn" class="w-full bg-gem-blue-500 hover:bg-gem-blue-700 text-white font-bold py-3 px-6 rounded-lg mt-6 text-lg transition-all">
                Get Started
            </button>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-40 opacity-0 pointer-events-none">
        <div class="flex items-center space-x-3">
            <svg class="animate-spin h-8 w-8 text-gem-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-lg font-semibold text-gem-blue-700">Simulating 1,000 futures...</span>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="max-w-screen-2xl mx-auto">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-6 md:mb-8 text-center md:text-left">Advanced Pension Forecast</h1>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8">
            
            <!-- Left Column: Inputs -->
            <div class="lg:col-span-1 bg-white rounded-xl shadow-lg p-6 md:p-8 space-y-8 h-fit">
                
                <!-- Section: Your Details -->
                <div class="space-y-6">
                    <h2 class="text-2xl font-semibold text-gray-800 border-b border-gray-200 pb-3">Your Details</h2>
                    
                    <!-- Current Age -->
                    <div class="slider-group">
                        <div class="flex justify-between items-center mb-2">
                            <label for="current-age" class="font-medium text-gray-700">Current Age</label>
                            <input type="number" id="current-age-value" class="value-input" value="40" min="18" max="100">
                        </div>
                        <input type="range" id="current-age" min="18" max="100" value="40" class="w-full">
                    </div>
                    
                    <!-- Retirement Age -->
                    <div class="slider-group">
                        <div class="flex justify-between items-center mb-2">
                            <label for="retirement-age" class="font-medium text-gray-700">Retirement Age</label>
                            <input type="number" id="retirement-age-value" class="value-input" value="65" min="18" max="100">
                        </div>
                        <input type="range" id="retirement-age" min="18" max="100" value="65" class="w-full">
                    </div>
                </div>

                <!-- Section: Default Assumptions -->
                <div class="space-y-6">
                    <h2 class="text-2xl font-semibold text-gray-800 border-b border-gray-200 pb-3">Default Assumptions</h2>
                    
                    <!-- Initial Investment -->
                    <div class="slider-group">
                        <div class="flex justify-between items-center mb-2">
                            <label for="initial-investment" class="font-medium text-gray-700">Initial Investment (£)</label>
                            <input type="number" id="initial-investment-value" class="value-input" value="100000" min="0" step="1000">
                        </div>
                        <input type="range" id="initial-investment" min="0" max="1000000" value="100000" step="1000" class="w-full">
                    </div>
                    
                    <!-- Default Contribution -->
                    <div class="slider-group">
                        <div class="flex justify-between items-center mb-2">
                            <label for="default-contribution" class="font-medium text-gray-700">Contribution (£/mo)</label>
                            <input type="number" id="default-contribution-value" class="value-input" value="500" min="0" step="50">
                        </div>
                        <input type="range" id="default-contribution" min="0" max="5000" value="500" step="50" class="w-full">
                    </div>
                    
                    <!-- Default Withdrawal -->
                    <div class="slider-group">
                        <div class="flex justify-between items-center mb-2">
                            <label for="default-withdrawal" class="font-medium text-gray-700">Withdrawal (£/yr)</label>
                            <input type="number" id="default-withdrawal-value" class="value-input" value="20000" min="0" step="1000">
                        </div>
                        <input type="range" id="default-withdrawal" min="0" max="150000" value="20000" step="1000" class="w-full">
                    </div>
                </div>
                
                <!-- Section: State Pension -->
                <div class="space-y-6">
                    <div class="flex items-center justify-between border-b border-gray-200 pb-3">
                        <h2 class="text-2xl font-semibold text-gray-800">State Pension</h2>
                        <input type="checkbox" id="include-state-pension">
                    </div>
                    
                    <div id="state-pension-inputs" class="space-y-6 hidden">
                        <!-- State Pension Amount -->
                        <div class="slider-group">
                            <div class="flex justify-between items-center mb-2">
                                <label for="state-pension-amount" class="font-medium text-gray-700">Amount (£/yr)</label>
                                <input type="number" id="state-pension-amount-value" class="value-input" value="10600" min="0" step="100">
                            </div>
                            <input type="range" id="state-pension-amount" min="0" max="20000" value="10600" step="100" class="w-full">
                        </div>
                        
                        <!-- State Pension Start Age -->
                        <div class="slider-group">
                            <div class="flex justify-between items-center mb-2">
                                <label for="state-pension-age" class="font-medium text-gray-700">Start Age</label>
                                <input type="number" id="state-pension-age-value" class="value-input" value="67" min="55" max="75">
                            </div>
                            <input type="range" id="state-pension-age" min="55" max="75" value="67" class="w-full">
                        </div>
                    </div>
                </div>
                
                <!-- Section: Monte Carlo Simulation -->
                <div class="space-y-6">
                    <div class="flex items-center justify-between border-b border-gray-200 pb-3">
                        <h2 class="text-2xl font-semibold text-gray-800">Monte Carlo Simulation</h2>
                        <input type="checkbox" id="run-monte-carlo" checked>
                    </div>

                    <div id="monte-carlo-inputs" class="space-y-6">
                        <!-- Stock/Bond Allocation -->
                        <div class="slider-group">
                            <div class="flex justify-between items-center mb-2">
                                <label for="stock-allocation" class="font-medium text-gray-700">Stock/Bond Allocation</label>
                                <span id="allocation-value" class="font-medium text-gray-900">60% / 40%</span>
                            </div>
                            <input type="range" id="stock-allocation" min="0" max="100" value="60" step="5" class="w-full">
                        </div>
                        
                        <!-- Annual Investment Fee -->
                        <div class="slider-group">
                            <div class="flex justify-between items-center mb-2">
                                <label for="investment-fee" class="font-medium text-gray-700">Annual Investment Fee (%)</label>
                                <input type="number" id="investment-fee-value" class="value-input" value="0.5" min="0" max="5" step="0.1">
                            </div>
                            <input type="range" id="investment-fee" min="0" max="5" value="0.5" step="0.1" class="w-full">
                        </div>
                        
                        <!-- Inflation Mean -->
                        <div class="slider-group">
                            <div class="flex justify-between items-center mb-2">
                                <label for="inflation-mean" class="font-medium text-gray-700">Average Annual Inflation (%)</label>
                                <input type="number" id="inflation-mean-value" class="value-input" value="2.5" min="0" max="10" step="0.1">
                            </div>
                            <input type="range" id="inflation-mean" min="0" max="10" value="2.5" step="0.1" class="w-full">
                        </div>
                        
                        <!-- Inflation Std Dev -->
                        <div class="slider-group">
                            <div class="flex justify-between items-center mb-2">
                                <label for="inflation-std-dev" class="font-medium text-gray-700">Inflation Volatility (Std Dev)</label>
                                <input type="number" id="inflation-std-dev-value" class="value-input" value="1.5" min="0" max="5" step="0.1">
                            </div>
                            <input type="range" id="inflation-std-dev" min="0" max="5" value="1.5" step="0.1" class="w-full">
                        </div>
                        
                        <!-- Adjust Withdrawals for Inflation -->
                        <div class="flex items-center justify-between pt-4">
                            <label for="adjust-inflation" class="font-medium text-gray-700 flex-1">Adjust withdrawals for inflation</label>
                            <input type="checkbox" id="adjust-inflation" checked>
                        </div>
                        
                        <!-- Advanced Asset Assumptions (Collapsible) -->
                        <div class="pt-4">
                            <button id="advanced-assumptions-toggle" aria-expanded="false" class="text-gem-blue-500 font-medium hover:text-gem-blue-700">
                                Advanced Asset Assumptions
                            </button>
                            <div id="advanced-assumptions-content" class="hidden mt-4 space-y-6 border-t border-gray-200 pt-6">
                                <!-- Stocks Mean -->
                                <div class="slider-group">
                                    <div class="flex justify-between items-center mb-2">
                                        <label for="stocks-mean" class="font-medium text-gray-700">Stocks Mean Return (%)</label>
                                        <input type="number" id="stocks-mean-value" class="value-input" value="8.0" min="-5" max="20" step="0.1">
                                    </div>
                                    <input type="range" id="stocks-mean" min="-5" max="20" value="8.0" step="0.1" class="w-full">
                                </div>
                                <!-- Stocks Std Dev -->
                                <div class="slider-group">
                                    <div class="flex justify-between items-center mb-2">
                                        <label for="stocks-std-dev" class="font-medium text-gray-700">Stocks Std Dev (%)</label>
                                        <input type="number" id="stocks-std-dev-value" class="value-input" value="16.0" min="0" max="40" step="0.5">
                                    </div>
                                    <input type="range" id="stocks-std-dev" min="0" max="40" value="16.0" step="0.5" class="w-full">
                                </div>
                                <!-- Bonds Mean -->
                                <div class="slider-group">
                                    <div class="flex justify-between items-center mb-2">
                                        <label for="bonds-mean" class="font-medium text-gray-700">Bonds Mean Return (%)</label>
                                        <input type="number" id="bonds-mean-value" class="value-input" value="2.5" min="-5" max="10" step="0.1">
                                    </div>
                                    <input type="range" id="bonds-mean" min="-5" max="10" value="2.5" step="0.1" class="w-full">
                                </div>
                                <!-- Bonds Std Dev -->
                                <div class="slider-group">
                                    <div class="flex justify-between items-center mb-2">
                                        <label for="bonds-std-dev" class="font-medium text-gray-700">Bonds Std Dev (%)</label>
                                        <input type="number" id="bonds-std-dev-value" class="value-input" value="5.0" min="0" max="15" step="0.1">
                                    </div>
                                    <input type="range" id="bonds-std-dev" min="0" max="15" value="5.0" step="0.1" class="w-full">
                                </div>
                                <!-- Correlation -->
                                <div class="slider-group">
                                    <div class="flex justify-between items-center mb-2">
                                        <label for="correlation" class="font-medium text-gray-700">Stock/Bond Correlation</label>

                                        <input type="number" id="correlation-value" class="value-input" value="-0.2" min="-1" max="1" step="0.1">
                                    </div>
                                    <input type="range" id="correlation" min="-1" max="1" value="-0.2" step="0.1" class="w-full">
                                </div>
                            </div>
                        </div>

                    </div>
                    
                </div>
            </div> <!-- End Left Column -->
            
            <!-- Right Column: Chart and Results -->
            <div class="lg:col-span-2 space-y-6 md:space-y-8">
                
                <!-- Summary Stats -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 md:gap-6">
                    <div class="bg-white rounded-xl shadow-lg p-5 text-center">
                        <h3 id="pot-at-retirement-label" class="text-sm font-medium text-gray-500 mb-1">Median Pot at Retirement</h3>
                        <p id="pot-at-retirement-stat" class="text-3xl font-bold text-gem-blue-700">£0</p>
                    </div>
                    <div id="success-rate-box" class="bg-white rounded-xl shadow-lg p-5 text-center">
                        <h3 class="text-sm font-medium text-gray-500 mb-1">Plan Success Rate</h3>
                        <p id="success-rate-stat" class="text-3xl font-bold text-gem-blue-700">0%</p>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-5 text-center">
                        <h3 id="runs-out-age-label" class="text-sm font-medium text-gray-500 mb-1">Median Runs Out Age</h3>
                        <p id="runs-out-age-stat" class="text-3xl font-bold text-gem-blue-700">N/A</p>
                    </div>
                </div>

                <!-- Chart -->
                <div class="bg-white rounded-xl shadow-lg p-4 md:p-6">
                    <canvas id="pensionChart"></canvas>
                </div>
                
                <!-- Yearly Plan Table -->
                <div class="bg-white rounded-xl shadow-lg p-4 md:p-6">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Customize Yearly Plan</h2>
                    <div class="overflow-x-auto max-h-[600px]">
                        <table class="w-full min-w-[600px] plan-table">
                            <thead class="sticky top-0 bg-white shadow-sm">
                                <tr>
                                    <th>Age</th>
                                    <th>Contribution (£/mo)</th>
                                    <th>Withdrawal (£/yr)</th>
                                    <th>Withdrawal (%)</th>
                                    <th>Total Income (£/yr)</th>
                                </tr>
                            </thead>
                            <tbody id="yearly-plan-body">
                                <!-- Rows will be generated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div> <!-- End Right Column -->

        </div> <!-- End Grid -->
    </div> <!-- End Main Content -->

    <script type="module">
        console.log("Script module loaded.");
    
        // Global state
        let pensionChart = null;
        let yearlyPlan = {};
        const NUM_SIMULATIONS = 1000;
        const MAX_AGE = 100;
        
        // --- Core Simulation Logic ---

        /**
         * Generates two standard normal random numbers (z-scores) using Box-Muller.
         */
        function getStandardNormalRandoms() {
            let u1, u2;
            do {
                u1 = Math.random();
                u2 = Math.random();
            } while (u1 <= 1e-6); // Avoid log(0)
            
            const z1 = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
            const z2 = Math.sqrt(-2.0 * Math.log(u1)) * Math.sin(2.0 * Math.PI * u2);
            return { z1, z2 };
        }

        /**
         * Helper to get lognormal parameters from arithmetic mean/stdDev
         * mean = 1.08 (value), stdDev = 0.16 (return)
         */
        function getLognormalParams(mean, stdDev) {
            const variance = stdDev * stdDev;
            const mu = Math.log(mean / Math.sqrt(1 + variance / (mean * mean)));
            const sigma = Math.sqrt(Math.log(1 + variance / (mean * mean)));
            return { mu, sigma };
        }
        
        /**
         * Helper to convert a standard normal (z) to a lognormal return
         */
        function convertToLognormalReturn(z, mu, sigma) {
            const lognormalVal = Math.exp(mu + z * sigma);
            return lognormalVal - 1; // Convert from 1.08 to 0.08
        }
        
        /**
         * Generates a single lognormal return (for inflation)
         */
        function getSingleLognormalReturn(mean, stdDev) {
             const { mu, sigma } = getLognormalParams(mean, stdDev);
             const { z1 } = getStandardNormalRandoms(); // z2 is unused
             return convertToLognormalReturn(z1, mu, sigma);
        }


        /**
         * Generates correlated random returns for stocks and bonds.
         */
        function getCorrelatedLognormalReturns(simParams) {
            const {
                stocksMean, stocksStdDev, bondsMean, bondsStdDev, correlation
            } = simParams;

            // 1. Get lognormal parameters for each asset
            // We pass 1.08, 0.16 etc.
            const { mu: stocksMu, sigma: stocksSigma } = getLognormalParams(1 + stocksMean, stocksStdDev);
            const { mu: bondsMu, sigma: bondsSigma } = getLognormalParams(1 + bondsMean, bondsStdDev);

            // 2. Generate two *independent* standard normal randoms
            const { z1, z2 } = getStandardNormalRandoms();

            // 3. Create two *correlated* standard normal randoms
            // z1 is for stocks
            const correlated_z_stocks = z1;
            // z2 is for bonds, correlated to z1
            const correlated_z_bonds = correlation * z1 + Math.sqrt(1 - correlation * correlation) * z2;

            // 4. Convert correlated standard normals to lognormal returns
            const stockReturn = convertToLognormalReturn(correlated_z_stocks, stocksMu, stocksSigma);
            const bondReturn = convertToLognormalReturn(correlated_z_bonds, bondsMu, bondsSigma);
            
            return { stockReturn, bondReturn };
        }

        /**
         * Runs a single simulation (one "lifetime")
         */
        function calculateSingleRun(params, simParams) {
            const {
                currentAge, retirementAge, initialInvestment,
                defaultContribution, defaultWithdrawal,
                includeStatePension, statePensionAmount, statePensionAge,
                adjustInflation, stockAllocation, investmentFee
            } = params;
            
            let pot = initialInvestment;
            let totalContribution = 0;
            let totalWithdrawal = 0;
            let inflationIndex = 1.0;
            let moneyRunsOutAge = null;
            
            const results = {
                potValues: [], // Pot value at *end* of each year
                incomeValues: [], // Total income *during* each year
            };
            
            for (let age = currentAge; age <= MAX_AGE; age++) {
                if (pot <= 0 && moneyRunsOutAge === null) {
                    moneyRunsOutAge = age;
                }
                
                // 1. Get this year's custom/default values
                const yearData = yearlyPlan[age] || {};
                const contribution = (age < retirementAge) 
                    ? (yearData.contribution !== undefined ? yearData.contribution : defaultContribution) * 12
                    : 0;
                
                let withdrawal = (age >= retirementAge)
                    ? (yearData.withdrawal !== undefined ? yearData.withdrawal : defaultWithdrawal)
                    : 0;
                
                // 2. Apply inflation adjustment if toggled
                if (age >= retirementAge && adjustInflation) {
                    withdrawal *= inflationIndex;
                }
                
                // 3. Get simulated returns for this year
                const { stockReturn, bondReturn } = simParams.runMonteCarlo
                    ? getCorrelatedLognormalReturns(simParams)
                    : { stockReturn: simParams.stocksMean, bondReturn: simParams.bondsMean }; // Use mean for single run
                
                const inflation = simParams.runMonteCarlo
                    ? getSingleLognormalReturn(1 + simParams.inflationMean, simParams.inflationStdDev)
                    : simParams.inflationMean;
                
                // Calculate weighted portfolio return
                const portfolioReturn = (stockReturn * stockAllocation) + (bondReturn * (1 - stockAllocation));
                
                // Subtract fees from the return
                const netReturn = portfolioReturn - investmentFee;
                
                // 4. Calculate this year's finance
                // (Pot + Contributions) * (1 + Net Return) - Withdrawals
                
                const potStartOfYear = pot;
                
                if (pot > 0) {
                    pot += contribution; // Add contributions at start of year
                    pot = pot * (1 + netReturn); // Apply gains/losses
                    pot -= withdrawal; // Subtract withdrawals at end of year
                }
                
                // Ensure pot doesn't go below zero
                if (pot < 0) {
                    withdrawal = Math.max(0, withdrawal + pot); // You can only withdraw what's left
                    pot = 0;
                }
                
                // 5. Calculate total income
                const statePension = (includeStatePension && age >= statePensionAge) ? statePensionAmount : 0;
                const totalIncome = withdrawal + statePension;
                
                // 6. Store results
                results.potValues.push({ age, value: pot, potStart: potStartOfYear });
                results.incomeValues.push({ age, value: totalIncome });
                
                // 7. Update inflation for next year
                inflationIndex *= (1 + inflation);
            }
            
            results.moneyRunsOutAge = moneyRunsOutAge || (pot > 0 ? null : MAX_AGE + 1);
            results.potAtRetirement = results.potValues.find(p => p.age === retirementAge)?.potStart || 0;

            return results;
        }

        /**
         * Runs the full Monte Carlo simulation N times
         */
        async function runMonteCarloSimulation(params) {
            const allSims = [];
            const simParams = getSimulationParams(params);
            
            for (let i = 0; i < NUM_SIMULATIONS; i++) {
                allSims.push(calculateSingleRun(params, simParams));
            }
            
            return processSimulationResults(allSims, params.currentAge);
        }
        
        /**
         * Runs a single deterministic simulation
         */
        async function runSingleSimulation(params) {
            const simParams = getSimulationParams(params);
            // Force returns to be their mean for a single run
            simParams.runMonteCarlo = false; 
            
            const result = calculateSingleRun(params, simParams);
            return processSimulationResults([result], params.currentAge);
        }

        /**
         * Processes the raw simulation data into percentiles for charting
         */
        function processSimulationResults(allSims, startAge) {
            const summary = {
                potAtRetirement: [],
                moneyRunsOutAge: [],
            };
            
            const percentiles = {
                p10_pot: [], p50_pot: [], p90_pot: [],
                p10_income: [], p50_income: [], p90_income: [],
                p50_potStart: [], // For withdrawal % calculation
            };
            
            // Collect summary stats
            allSims.forEach(sim => {
                summary.potAtRetirement.push(sim.potAtRetirement);
                if (sim.moneyRunsOutAge) {
                    summary.moneyRunsOutAge.push(sim.moneyRunsOutAge);
                }
            });
            
            // Sort summary stats to find median
            summary.potAtRetirement.sort((a, b) => a - b);
            summary.moneyRunsOutAge.sort((a, b) => a - b);
            
            const medianPotAtRetirement = summary.potAtRetirement[Math.floor(allSims.length / 2)] || 0;
            const medianRunsOutAge = summary.moneyRunsOutAge[Math.floor(summary.moneyRunsOutAge.length / 2)] || null;
            const successRate = 1 - (summary.moneyRunsOutAge.length / allSims.length);

            // Process percentiles for each age
            for (let i = 0; i <= MAX_AGE - startAge; i++) {
                const age = startAge + i;
                const potValuesForAge = allSims.map(sim => sim.potValues[i].value).sort((a, b) => a - b);
                const potStartValuesForAge = allSims.map(sim => sim.potValues[i].potStart).sort((a, b) => a - b);
                const incomeValuesForAge = allSims.map(sim => sim.incomeValues[i].value).sort((a, b) => a - b);
                
                percentiles.p10_pot.push(potValuesForAge[Math.floor(allSims.length * 0.1)]);
                percentiles.p50_pot.push(potValuesForAge[Math.floor(allSims.length * 0.5)]);
                percentiles.p90_pot.push(potValuesForAge[Math.floor(allSims.length * 0.9)]);
                
                percentiles.p50_potStart.push(potStartValuesForAge[Math.floor(allSims.length * 0.5)]);
                
                percentiles.p10_income.push(incomeValuesForAge[Math.floor(allSims.length * 0.1)]);
                percentiles.p50_income.push(incomeValuesForAge[Math.floor(allSims.length * 0.5)]);
                percentiles.p90_income.push(incomeValuesForAge[Math.floor(allSims.length * 0.9)]);
            }

            return {
                medianPotAtRetirement,
                medianRunsOutAge,
                successRate,
                percentiles
            };
        }
        
        
        // --- UI & Charting Logic ---

        function initChart() {
            const ctx = document.getElementById('pensionChart').getContext('2d');
            
            // Create gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(0, 123, 255, 0.4)'); // gem-blue-500 with opacity
            gradient.addColorStop(1, 'rgba(0, 123, 255, 0.0)');
            
            pensionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [], // Ages
                    datasets: [
                        {
                            label: '90th Percentile',
                            data: [],
                            borderColor: 'rgba(123, 196, 255, 0.5)', // gem-blue-300
                            borderWidth: 1.5,
                            pointRadius: 0,
                            fill: false,
                        },
                        {
                            label: '10th Percentile',
                            data: [],
                            borderColor: 'rgba(123, 196, 255, 0.5)', // gem-blue-300
                            borderWidth: 1.5,
                            pointRadius: 0,
                            fill: '-1', // Fill to previous dataset
                            backgroundColor: gradient,
                        },
                        {
                            label: 'Median Pot Value', // 50th Percentile
                            data: [],
                            borderColor: '#002c5a', // gem-blue-900
                            borderWidth: 2.5,
                            pointRadius: 0,
                            fill: false,
                        },
                        {
                            label: 'Total Annual Income',
                            data: [],
                            backgroundColor: 'rgba(0, 86, 179, 0.6)', // gem-blue-700
                            borderColor: '#0056b3',
                            borderWidth: 1,
                            type: 'bar',
                            yAxisID: 'y1', // Secondary axis
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Allows us to control height
                    aspectRatio: 1.5, // Taller chart
                    animation: false,
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', maximumFractionDigits: 0 }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                boxWidth: 10
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Age'
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: { // Primary axis for pot value
                            type: 'linear',
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Pension Pot Value (£)'
                            },
                            ticks: {
                                callback: value => `£${(value / 1000)}k`
                            },
                            grid: {
                                color: '#e5e7eb' // bg-gray-200
                            }
                        },
                        y1: { // Secondary axis for income
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Annual Income (£)'
                            },
                            ticks: {
                                callback: value => `£${(value / 1000)}k`
                            },
                            grid: {
                                display: false // Only show primary grid
                            }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    }
                }
            });
        }

        function updateChart(data, labels, retirementAge) {
            if (!pensionChart) return;
            
            const isMonteCarlo = data.p10_pot !== undefined;
            
            pensionChart.data.labels = labels;
            
            // Percentile lines
            pensionChart.data.datasets[0].data = data.p10_pot || [];
            pensionChart.data.datasets[1].data = data.p90_pot || [];
            
            // Median/Single line
            pensionChart.data.datasets[2].data = data.p50_pot || [];
            pensionChart.data.datasets[2].label = isMonteCarlo ? 'Median Pot Value' : 'Pot Value';

            // Income bars
            pensionChart.data.datasets[3].data = data.p50_income || [];
            pensionChart.data.datasets[3].label = isMonteCarlo ? 'Median Total Income' : 'Total Income';
            
            // Show/hide percentile lines based on simulation type
            pensionChart.data.datasets[0].hidden = !isMonteCarlo;
            pensionChart.data.datasets[1].hidden = !isMonteCarlo;

            // Add annotation for retirement age
            pensionChart.options.plugins.annotation = {
                annotations: {
                    line1: {
                        type: 'line',
                        xMin: retirementAge,
                        xMax: retirementAge,
                        borderColor: 'rgb(255, 99, 132)',
                        borderWidth: 2,
                        borderDash: [6, 6],
                        label: {
                            content: 'Retirement',
                            display: true,
                            position: 'start',
                            backgroundColor: 'rgba(255, 99, 132, 0.8)'
                        }
                    }
                }
            };
            
            pensionChart.update();
        }

        function updateSummaryStats(stats, isMonteCarlo) {
            const formatCurrency = (val) => new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', maximumFractionDigits: 0 }).format(val);
            
            const potVal = stats.medianPotAtRetirement || 0;
            const runsOutVal = stats.medianRunsOutAge || "N/A";
            
            document.getElementById('pot-at-retirement-stat').textContent = formatCurrency(potVal);
            document.getElementById('runs-out-age-stat').textContent = runsOutVal;
            
            const successRateBox = document.getElementById('success-rate-box');
            if (isMonteCarlo) {
                document.getElementById('success-rate-stat').textContent = `${(stats.successRate * 100).toFixed(0)}%`;
                successRateBox.style.display = 'block';
                // Update labels for MC
                document.getElementById('pot-at-retirement-label').textContent = "Median Pot at Retirement";
                document.getElementById('runs-out-age-label').textContent = "Median Runs Out Age";
            } else {
                successRateBox.style.display = 'none';
                // Update labels for single run
                document.getElementById('pot-at-retirement-label').textContent = "Pot at Retirement";
                document.getElementById('runs-out-age-label').textContent = "Pot Runs Out Age";
            }
        }
        
        function updateYearlyPlanTable(params, simResults) {
            const { currentAge, retirementAge } = params;
            const tableBody = document.getElementById('yearly-plan-body');
            tableBody.innerHTML = '';
            
            const isMonteCarlo = simResults.percentiles.p50_potStart !== undefined;
            
            for (let age = currentAge; age <= MAX_AGE; age++) {
                const row = document.createElement('tr');
                const yearData = yearlyPlan[age] || {};
                const yearIndex = age - currentAge;
                
                // Get median values from simulation results
                const medianPotStart = simResults.percentiles.p50_potStart[yearIndex];
                const medianIncome = simResults.percentiles.p50_income[yearIndex];
                
                // Determine withdrawal amount (from user input or default)
                let withdrawalAmount = (age >= retirementAge)
                    ? (yearData.withdrawal !== undefined ? yearData.withdrawal : params.defaultWithdrawal)
                    : 0;
                
                let withdrawalPct = 0;
                if (age >= retirementAge && medianPotStart > 0) {
                    // We need to know the *actual* withdrawal amount in the median sim
                    // The "medianIncome" includes state pension.
                    const statePension = (params.includeStatePension && age >= params.statePensionAge) ? params.statePensionAmount : 0;
                    const medianWithdrawal = medianIncome - statePension;
                    
                    // Fix: Calculate % based on pot *before* withdrawal (potStart)
                    withdrawalPct = (medianWithdrawal / medianPotStart) * 100;
                }

                row.innerHTML = `
                    <td class="font-medium">${age}</td>
                    <td>
                        <input 
                            type="number" 
                            data-age="${age}" 
                            data-type="contribution" 
                            placeholder="${params.defaultContribution}"
                            value="${yearData.contribution ?? ''}"
                            min="0"
                            step="50"
                            ${age >= retirementAge ? 'disabled class="bg-gray-100"' : ''}
                        >
                    </td>
                    <td>
                        <input 
                            type="number" 
                            data-age="${age}" 
                            data-type="withdrawal" 
                            placeholder="${params.defaultWithdrawal}"
                            value="${yearData.withdrawal ?? ''}"
                            min="0"
                            step="1000"
                            ${age < retirementAge ? 'disabled class="bg-gray-100"' : ''}
                        >
                    </td>
                    <td class="text-right ${age < retirementAge ? 'text-gray-400' : ''}">
                        ${age >= retirementAge ? withdrawalPct.toFixed(1) + '%' : 'N/A'}
                    </td>
                    <td class="text-right font-medium ${age < retirementAge ? 'text-gray-400' : ''}">
                        ${new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', maximumFractionDigits: 0 }).format(medianIncome)}
                    </td>
                `;
                tableBody.appendChild(row);
            }
        }
        
        // --- Data Getters ---
        
        function getUIParams() {
            return {
                currentAge: parseInt(document.getElementById('current-age').value),
                retirementAge: parseInt(document.getElementById('retirement-age').value),
                initialInvestment: parseFloat(document.getElementById('initial-investment').value),
                defaultContribution: parseFloat(document.getElementById('default-contribution').value),
                defaultWithdrawal: parseFloat(document.getElementById('default-withdrawal').value),
                includeStatePension: document.getElementById('include-state-pension').checked,
                statePensionAmount: parseFloat(document.getElementById('state-pension-amount').value),
                statePensionAge: parseInt(document.getElementById('state-pension-age').value),
                runMonteCarlo: document.getElementById('run-monte-carlo').checked,
                adjustInflation: document.getElementById('adjust-inflation').checked,
                stockAllocation: parseFloat(document.getElementById('stock-allocation').value) / 100,
                investmentFee: parseFloat(document.getElementById('investment-fee').value) / 100,
            };
        }
        
        function getSimulationParams(uiParams) {
            // These are the "hidden" advanced params
            return {
                runMonteCarlo: uiParams.runMonteCarlo,
                inflationMean: parseFloat(document.getElementById('inflation-mean').value) / 100,
                inflationStdDev: parseFloat(document.getElementById('inflation-std-dev').value) / 100,
                stocksMean: parseFloat(document.getElementById('stocks-mean').value) / 100,
                stocksStdDev: parseFloat(document.getElementById('stocks-std-dev').value) / 100,
                bondsMean: parseFloat(document.getElementById('bonds-mean').value) / 100,
                bondsStdDev: parseFloat(document.getElementById('bonds-std-dev').value) / 100,
                correlation: parseFloat(document.getElementById('correlation').value),
            };
        }
        

        // --- Main Execution Function ---

        let isRunning = false;
        async function runFullSimulation() {
            if (isRunning) return; // Prevent concurrent runs
            isRunning = true;
            
            const loadingOverlay = document.getElementById('loading-overlay');
            if (getUIParams().runMonteCarlo) {
                loadingOverlay.classList.remove('opacity-0', 'pointer-events-none');
            }
            
            // Give the browser a moment to render the overlay
            await new Promise(resolve => setTimeout(resolve, 20));

            let params, simResults; // Declare here to be in scope
            try {
                params = getUIParams();
                simResults = params.runMonteCarlo 
                    ? await runMonteCarloSimulation(params)
                    : await runSingleSimulation(params);
                
                console.log("Simulation complete. Final results:", simResults);
            } catch (error) {
                console.error("Error during simulation:", error);
                // Hide overlay and stop on error
                loadingOverlay.classList.add('opacity-0', 'pointer-events-none');
                isRunning = false;
                return; // Don't proceed
            }

            // Prep data for chart
            const labels = Array.from({ length: MAX_AGE - params.currentAge + 1 }, (_, i) => params.currentAge + i);
            const chartData = {
                p10_pot: params.runMonteCarlo ? simResults.percentiles.p10_pot : undefined,
                p90_pot: params.runMonteCarlo ? simResults.percentiles.p90_pot : undefined,
                p50_pot: simResults.percentiles.p50_pot,
                p50_income: simResults.percentiles.p50_income
            };
            
            console.log("Updating chart...");
            updateChart(chartData, labels, params.retirementAge);
            console.log("Updating summary stats...");
            updateSummaryStats(simResults, params.runMonteCarlo);
            console.log("Updating yearly table...");
            updateYearlyPlanTable(params, simResults);
            
            // Hide overlay
            loadingOverlay.classList.add('opacity-0', 'pointer-events-none');
            isRunning = false;
        }

        // --- Event Listeners Setup ---
        
        function initialize() {
            console.log("Initializing app...");
            try {
                initChart();

                // Link sliders to text inputs
                const inputs = [
                    'current-age', 'retirement-age', 'initial-investment', 'default-contribution',
                    'default-withdrawal', 'state-pension-amount', 'state-pension-age', 'investment-fee',
                    'stock-allocation', // Add stock-allocation here for the change handler
                    'inflation-mean', 'inflation-std-dev', 'stocks-mean', 'stocks-std-dev',
                    'bonds-mean', 'bonds-std-dev', 'correlation'
                ];
            
                inputs.forEach(id => {
                    const slider = document.getElementById(id);
                    const valueBox = document.getElementById(id === 'stock-allocation' ? 'allocation-value' : `${id}-value`);

                    if (!slider || !valueBox) {
                        console.warn(`Elements not found for ID: ${id}`);
                        return; // Skip this one
                    }
                    
                    if (id === 'stock-allocation') {
                        // Special handler for stock allocation
                        slider.addEventListener('input', () => {
                            updateAllocationLabel(slider.value);
                        });
                        // No value-box listener needed
                    } else {
                        // Standard handler for number inputs
                        // Slider -> Value Box
                        slider.addEventListener('input', () => {
                            valueBox.value = slider.value;
                        });
                        
                        // Value Box -> Slider
                        valueBox.addEventListener('change', () => {
                            let val = parseFloat(valueBox.value);
                            const min = parseFloat(slider.min);
                            const max = parseFloat(slider.max);
                            if (isNaN(val)) val = min;
                            if (val < min) val = min;
                            if (val > max) val = max;
                            valueBox.value = val;
                            slider.value = val;
                            runFullSimulation();
                        });
                    }
                    
                    // Re-run simulation on slider change (mouseup)
                    slider.addEventListener('change', runFullSimulation);
                });
            
                // Special handler for stock allocation label
                function updateAllocationLabel(stockPct) {
                    const bondPct = 100 - stockPct;
                    const label = document.getElementById('allocation-value');
                    if (label) label.textContent = `${stockPct}% / ${bondPct}%`;
                }
                // Initial call for stock allocation label
                updateAllocationLabel(document.getElementById('stock-allocation').value);

                // Checkbox listeners
                const checkboxes = [
                    'include-state-pension', 'run-monte-carlo', 'adjust-inflation'
                ];
                checkboxes.forEach(id => {
                    const checkbox = document.getElementById(id);
                    if (checkbox) {
                        checkbox.addEventListener('change', () => {
                            toggleSections();
                            runFullSimulation();
                        });
                    }
                });

                // State Pension section toggle
                function toggleSections() {
                    const spInputs = document.getElementById('state-pension-inputs');
                    const spCheck = document.getElementById('include-state-pension');
                    if (spInputs && spCheck) {
                        spInputs.classList.toggle('hidden', !spCheck.checked);
                    }
                    
                    const mcInputs = document.getElementById('monte-carlo-inputs');
                    const mcCheck = document.getElementById('run-monte-carlo');
                    if (mcInputs && mcCheck) {
                        mcInputs.classList.toggle('hidden', !mcCheck.checked);
                    }
                }
                toggleSections(); // Initial call
                
                // Advanced Assumptions toggle
                const advancedToggle = document.getElementById('advanced-assumptions-toggle');
                const advancedContent = document.getElementById('advanced-assumptions-content');
                if (advancedToggle && advancedContent) {
                    advancedToggle.addEventListener('click', () => {
                        const isExpanded = advancedToggle.getAttribute('aria-expanded') === 'true';
                        advancedToggle.setAttribute('aria-expanded', !isExpanded);
                        advancedContent.classList.toggle('hidden');
                    });
                }
                
                // Yearly plan table listener
                const yearlyPlanBody = document.getElementById('yearly-plan-body');
                if (yearlyPlanBody) {
                    yearlyPlanBody.addEventListener('change', (e) => {
                        if (e.target.tagName === 'INPUT') {
                            const age = parseInt(e.target.dataset.age);
                            const type = e.target.dataset.type;
                            const value = e.target.value === '' ? undefined : parseFloat(e.target.value);
                            
                            if (!yearlyPlan[age]) {
                                yearlyPlan[age] = {};
                            }
                            yearlyPlan[age][type] = value;
                            
                            // If a value is cleared, remove it from the object to use default
                            if (value === undefined) {
                                delete yearlyPlan[age][type];
                            }
                            
                            runFullSimulation();
                        }
                    });
                }
                
                // Modal listeners
                const modal = document.getElementById('welcome-modal');
                const modalContent = modal.querySelector('.modal-content');
                const closeModalBtn = document.getElementById('close-modal-btn');
                const getStartedBtn = document.getElementById('get-started-btn');
                
                function openModal() {
                    if (modal && modalContent) {
                        modal.classList.remove('opacity-0', 'invisible');
                        modalContent.classList.remove('scale-95', 'opacity-0');
                    }
                }
                
                function closeModal() {
                    if (modal && modalContent) {
                        modalContent.classList.add('scale-95', 'opacity-0');
                        modal.classList.add('opacity-0', 'invisible');
                    }
                }
                
                if (closeModalBtn) closeModalBtn.addEventListener('click', closeModal);
                if (getStartedBtn) getStartedBtn.addEventListener('click', closeModal);
                
                // Check if user has visited before
                if (!localStorage.getItem('pensionCalcVisited')) {
                    openModal();
                    localStorage.setItem('pensionCalcVisited', 'true');
                } else {
                    closeModal(); // Start closed
                }

                // Initial simulation run
                console.log("Running initial simulation...");
                runFullSimulation();
                console.log("Initialization complete.");
            } catch (err) {
                console.error("Error during app initialization:", err);
            }
        }

        // Run initialize when the DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM content loaded. Starting initialize.");
            initialize();
        });
        
    </script>
</body>
</html>


