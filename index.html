<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pension Forecast Calculator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Configure Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Helvetica', 'sans-serif'],
                    },
                    colors: {
                        'gem-blue': {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles */
        body {
            font-family: 'Helvetica', 'sans-serif';
            overscroll-behavior: none;
        }

        /* Custom slider track */
        input[type="range"]::-webkit-slider-runnable-track {
            height: 6px;
            background: #e5e7eb; /* gray-200 */
            border-radius: 9999px;
        }
        input[type="range"]::-moz-range-track {
            height: 6px;
            background: #e5e7eb; /* gray-200 */
            border-radius: 9999px;
        }

        /* Custom slider thumb */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #0284c7; /* gem-blue-600 */
            border-radius: 50%;
            cursor: pointer;
            margin-top: -6px; /* Center thumb on track */
            transition: background 0.2s ease;
        }
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #0284c7; /* gem-blue-600 */
            border-radius: 50%;
            cursor: pointer;
            border: none;
            transition: background 0.2s ease;
        }

        input[type="range"]:hover::-webkit-slider-thumb {
            background: #0369a1; /* gem-blue-700 */
        }
        input[type="range"]:hover::-moz-range-thumb {
            background: #0369a1; /* gem-blue-700 */
        }

        /* Input number spin button hiding */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="h-full bg-gray-50 text-gray-800 antialiased">

    <!-- Welcome Modal -->
    <div id="welcomeModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl transform transition-all scale-100 opacity-100" id="welcomeModalContent">
            <div class="px-6 py-5 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-gray-900">Welcome to the Pension Forecaster!</h2>
                <p class="text-sm text-gray-500">Here's a quick guide to get you started.</p>
            </div>
            <div class="p-6 space-y-4 text-gray-700 max-h-[60vh] overflow-y-auto">
                <div class="space-y-3">
                    <p class="font-semibold text-gem-blue-700">Step 1: Set Your Basic Plan</p>
                    <p>Use the sliders on the left to set your <span class="font-bold">Current Age</span>, <span class="font-bold">Retirement Age</span>, and <span class="font-bold">Initial Investment</span>. These set the foundation for your forecast.</p>
                    
                    <p class="font-semibold text-gem-blue-700">Step 2: Define Your Defaults</p>
                    <p>Set your <span class="font-bold">Default Contributions</span> (monthly) and <span class="font-bold">Default Withdrawals</span> (annually) for retirement. You can also include your <span class="font-bold">State Pension</span>.</p>
                    
                    <p class="font-semibold text-gem-blue-700">Step 3: Model Reality with Monte Carlo</p>
                    <p>This is the most powerful part. Instead of a single, fixed return, we can simulate 1,000 possible futures based on market volatility.</p>
                    <ul class="list-disc list-outside ml-6 space-y-1 marker:text-gem-blue-500">
                        <li>Check <span class="font-bold">"Monte Carlo Simulation"</span> to turn this on.</li>
                        <li>The app now models your pot as a mix of <span class="font-bold">Stocks & Bonds</span>. You can set this mix with the slider.</li>
                        <li>Set the <span class="font-bold">Annual Investment Fee</span>, which has a big impact over time.</li>
                        <li>You can also model <span class="font-bold">Inflation</span> and have your withdrawals automatically adjust to keep up.</li>
                    </ul>

                    <p class="font-semibold text-gem-blue-700">Step 4: Read the Graph</p>
                    <p>When Monte Carlo is on, the graph shows a <span class="font-bold">probability band</span>:</p>
                    <ul class="list-disc list-outside ml-6 space-y-1 marker:text-gem-blue-500">
                        <li><span class="font-bold">50th Percentile (Solid Black Line):</span> The "median" or most likely outcome.</li>
                        <li><span class="font-bold">10th-90th Percentile (Blue Band):</span> The range of 80% of all outcomes. The bottom is a "poor" result, the top is a "good" result.</li>
                        <li>Look at the <span class="font-bold">"Plan Success Rate"</span>. This is the % of the 1,000 simulations where your money lasted until age 100.</li>
                    </ul>

                    <p class="font-semibold text-gem-blue-700">Step 5: Customize Your Plan (Advanced)</p>
                    <p>At the bottom, the <span class="font-bold">"Customize Yearly Plan"</span> table lets you override the defaults for any specific year. Want to contribute more at 50? Or withdraw less at 70? You can set that here.</p>
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 rounded-b-xl text-right">
                <button id="closeModalButton" class="bg-gem-blue-600 text-white font-semibold px-5 py-2.5 rounded-lg shadow-sm hover:bg-gem-blue-700 transition duration-200">Start Planning</button>
            </div>
        </div>
    </div>

    <!-- Simulation Overlay -->
    <div id="simulationOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-40 flex items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none">
        <div class="bg-white rounded-lg shadow-xl p-6 flex items-center space-x-4">
            <svg class="animate-spin h-6 w-6 text-gem-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-lg font-medium text-gray-700">Running 1,000 simulations...</span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-screen-xl mx-auto p-4 md:p-6 lg:p-8 space-y-6">

        <!-- Header -->
        <header class="pb-4 border-b border-gray-200">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Pension Forecast Calculator</h1>
            <p class="mt-2 text-lg text-gray-600">Model your pension growth and retirement income with Monte Carlo simulations.</p>
        </header>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Left Column: Inputs -->
            <div class="lg:col-span-1 space-y-6">
                
                <!-- Core Inputs -->
                <div class="bg-white p-5 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold text-gray-900 border-b border-gray-200 pb-3 mb-4">Your Plan</h2>
                    
                    <!-- Current Age -->
                    <div class="mb-5">
                        <div class="flex justify-between items-center mb-1.5">
                            <label for="currentAge" class="font-semibold text-gray-700">Current Age</label>
                            <span class="text-lg font-bold text-gem-blue-700"><span id="currentAgeValue">40</span></span>
                        </div>
                        <input type="range" id="currentAge" min="18" max="100" value="40" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-sm">
                    </div>
                    
                    <!-- Retirement Age -->
                    <div class="mb-5">
                        <div class="flex justify-between items-center mb-1.5">
                            <label for="retirementAge" class="font-semibold text-gray-700">Retirement Age</label>
                            <span class="text-lg font-bold text-gem-blue-700"><span id="retirementAgeValue">65</span></span>
                        </div>
                        <input type="range" id="retirementAge" min="18" max="100" value="65" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-sm">
                    </div>
                </div>

                <!-- Default Assumptions -->
                <div class="bg-white p-5 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold text-gray-900 border-b border-gray-200 pb-3 mb-4">Default Assumptions</h2>

                    <!-- Initial Investment -->
                    <div class="mb-5">
                        <label for="initialInvestment" class="font-semibold text-gray-700 mb-1.5 block">Initial Investment (£)</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">£</span>
                            <input type="number" id="initialInvestment" value="50000" class="w-full pl-7 pr-4 py-2.5 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-gem-blue-500 focus:border-transparent transition">
                        </div>
                    </div>
                    
                    <!-- Default Contribution -->
                    <div class="mb-5">
                        <label for="defaultContribution" class="font-semibold text-gray-700 mb-1.5 block">Default Contribution (£/month)</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">£</span>
                            <input type="number" id="defaultContribution" value="300" class="w-full pl-7 pr-4 py-2.5 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-gem-blue-500 focus:border-transparent transition">
                        </div>
                    </div>

                    <!-- Default Withdrawal -->
                    <div class="mb-5">
                        <label for="defaultWithdrawal" class="font-semibold text-gray-700 mb-1.5 block">Default Withdrawal (£/year)</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">£</span>
                            <input type="number" id="defaultWithdrawal" value="20000" class="w-full pl-7 pr-4 py-2.5 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-gem-blue-500 focus:border-transparent transition">
                        </div>
                    </div>

                    <!-- State Pension -->
                    <div class="border-t border-gray-200 pt-4">
                        <div class="flex items-center">
                            <input type="checkbox" id="includeStatePension" class="h-5 w-5 text-gem-blue-600 rounded border-gray-300 focus:ring-gem-blue-500">
                            <label for="includeStatePension" class="ml-3 font-semibold text-gray-700">Include State Pension</label>
                        </div>
                        <div id="statePensionInputs" class="mt-4 space-y-4 hidden">
                            <div>
                                <label for="statePensionAmount" class="font-semibold text-gray-700 mb-1.5 block">State Pension (£/year)</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">£</span>
                                    <input type="number" id="statePensionAmount" value="11500" class="w-full pl-7 pr-4 py-2.5 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-gem-blue-500 focus:border-transparent transition">
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between items-center mb-1.5">
                                    <label for="statePensionStartAge" class="font-semibold text-gray-700">State Pension Start Age</label>
                                    <span class="text-lg font-bold text-gem-blue-700"><span id="statePensionStartAgeValue">67</span></span>
                                </div>
                                <input type="range" id="statePensionStartAge" min="55" max="75" value="67" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-sm">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Monte Carlo Simulation -->
                <div class="bg-white p-5 rounded-xl shadow-lg">
                    <div class="flex items-center mb-4 pb-3 border-b border-gray-200">
                        <input type="checkbox" id="runMonteCarlo" class="h-5 w-5 text-gem-blue-600 rounded border-gray-300 focus:ring-gem-blue-500" checked>
                        <label for="runMonteCarlo" class="ml-3 text-xl font-bold text-gray-900">Monte Carlo Simulation</label>
                    </div>

                    <div id="monteCarloInputs" class="space-y-5">
                        <!-- Stock/Bond Allocation -->
                        <div>
                            <div class="flex justify-between items-center mb-1.5">
                                <label for="stockAllocation" class="font-semibold text-gray-700">Stock / Bond Allocation</label>
                                <span class="text-lg font-bold text-gem-blue-700"><span id="stockAllocationValue">60</span>% / <span id="bondAllocationValue">40</span>%</span>
                            </div>
                            <input type="range" id="stockAllocation" min="0" max="100" value="60" step="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-sm">
                        </div>

                        <!-- Annual Investment Fee -->
                        <div>
                            <div class="flex justify-between items-center mb-1.5">
                                <label for="investmentFee" class="font-semibold text-gray-700">Annual Investment Fee</label>
                                <span class="text-lg font-bold text-gem-blue-700"><span id="investmentFeeValue">0.50</span>%</span>
                            </div>
                            <input type="range" id="investmentFee" min="0" max="3" value="0.5" step="0.05" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-sm">
                        </div>

                        <!-- Inflation -->
                        <div class="border-t border-gray-200 pt-4 space-y-5">
                            <div>
                                <div class="flex justify-between items-center mb-1.5">
                                    <label for="avgInflation" class="font-semibold text-gray-700">Average Annual Inflation</label>
                                    <span class="text-lg font-bold text-gem-blue-700"><span id="avgInflationValue">2.5</span>%</span>
                                </div>
                                <input type="range" id="avgInflation" min="0" max="10" value="2.5" step="0.1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-sm">
                            </div>
                            <div>
                                <div class="flex justify-between items-center mb-1.5">
                                    <label for="stdDevInflation" class="font-semibold text-gray-700">Inflation Volatility (Std Dev)</label>
                                    <span class="text-lg font-bold text-gem-blue-700"><span id="stdDevInflationValue">1.5</span>%</span>
                                </div>
                                <input type="range" id="stdDevInflation" min="0" max="5" value="1.5" step="0.1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-sm">
                            </div>
                            <div class="flex items-center pt-2">
                                <input type="checkbox" id="adjustForInflation" class="h-5 w-5 text-gem-blue-600 rounded border-gray-300 focus:ring-gem-blue-500" checked>
                                <label for="adjustForInflation" class="ml-3 font-medium text-gray-700">Adjust withdrawals for inflation</label>
                            </div>
                        </div>

                        <!-- Advanced Asset Assumptions -->
                        <div class="border-t border-gray-200 pt-4">
                            <details class="group">
                                <summary class="flex justify-between items-center cursor-pointer text-gray-700 font-semibold list-none">
                                    Advanced Asset Assumptions
                                    <svg class="w-5 h-5 transition-transform duration-200 group-open:rotate-180" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                                    </svg>
                                </summary>
                                <div class="mt-4 space-y-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                                    <!-- Stocks -->
                                    <div class="space-y-2">
                                        <label class="font-semibold text-gray-600 text-sm">Stocks (Equities)</label>
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label for="stocksMean" class="text-xs text-gray-500 block mb-1">Mean Return</label>
                                                <div class="relative">
                                                    <input type="number" id="stocksMean" value="8" step="0.1" class="w-full pl-3 pr-6 py-2 text-sm rounded-md border border-gray-300 focus:outline-none focus:ring-1 focus:ring-gem-blue-500">
                                                    <span class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 text-sm">%</span>
                                                </div>
                                            </div>
                                            <div>
                                                <label for="stocksStdDev" class="text-xs text-gray-500 block mb-1">Std Deviation</label>
                                                <div class="relative">
                                                    <input type="number" id="stocksStdDev" value="16" step="0.1" class="w-full pl-3 pr-6 py-2 text-sm rounded-md border border-gray-300 focus:outline-none focus:ring-1 focus:ring-gem-blue-500">
                                                    <span class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 text-sm">%</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Bonds -->
                                    <div class="space-y-2">
                                        <label class="font-semibold text-gray-600 text-sm">Bonds (Fixed Income)</label>
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label for="bondsMean" class="text-xs text-gray-500 block mb-1">Mean Return</label>
                                                <div class="relative">
                                                    <input type="number" id="bondsMean" value="2.5" step="0.1" class="w-full pl-3 pr-6 py-2 text-sm rounded-md border border-gray-300 focus:outline-none focus:ring-1 focus:ring-gem-blue-500">
                                                    <span class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 text-sm">%</span>
                                                </div>
                                            </div>
                                            <div>
                                                <label for="bondsStdDev" class="text-xs text-gray-500 block mb-1">Std Deviation</label>
                                                <div class="relative">
                                                    <input type="number" id="bondsStdDev" value="5" step="0.1" class="w-full pl-3 pr-6 py-2 text-sm rounded-md border border-gray-300 focus:outline-none focus:ring-1 focus:ring-gem-blue-500">
                                                    <span class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 text-sm">%</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Correlation -->
                                    <div class="space-y-2">
                                        <label for="correlation" class="font-semibold text-gray-600 text-sm">Stock/Bond Correlation</label>
                                        <input type="number" id="correlation" value="-0.2" step="0.05" min="-1" max="1" class="w-full pl-3 pr-6 py-2 text-sm rounded-md border border-gray-300 focus:outline-none focus:ring-1 focus:ring-gem-blue-500">
                                    </div>
                                </div>
                            </details>
                        </div>

                    </div>
                    
                    <div id="singleRunInputs" class="space-y-5 hidden">
                        <!-- Default Annual Return -->
                        <div>
                            <div class="flex justify-between items-center mb-1.5">
                                <label for="defaultReturn" class="font-semibold text-gray-700">Default Annual Return</label>
                                <span class="text-lg font-bold text-gem-blue-700"><span id="defaultReturnValue">7.0</span>%</span>
                            </div>
                            <input type="range" id="defaultReturn" min="0" max="20" value="7" step="0.1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-sm">
                        </div>
                    </div>

                </div>

            </div> <!-- End Left Column -->
            
            <!-- Right Column: Chart and Stats -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- Summary Stats -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="bg-white p-5 rounded-xl shadow-lg text-center">
                        <h3 id="stat1Label" class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Median Pot at Retirement</h3>
                        <span id="potAtRetirement" class="text-3xl font-bold text-gem-blue-700 mt-2 block">£0</span>
                    </div>
                    <div id="successRateBox" class="bg-white p-5 rounded-xl shadow-lg text-center">
                        <h3 id="stat2Label" class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Plan Success Rate</h3>
                        <span id="planSuccessRate" class="text-3xl font-bold text-gem-blue-700 mt-2 block">0%</span>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-lg text-center">
                        <h3 id="stat3Label" class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Median Runs Out Age</h3>
                        <span id="moneyRunsOutAge" class="text-3xl font-bold text-gem-blue-700 mt-2 block">N/A</span>
                    </div>
                </div>

                <!-- Chart -->
                <div class="bg-white p-4 md:p-6 rounded-xl shadow-lg">
                    <canvas id="pensionChart"></canvas>
                </div>

                <!-- Yearly Plan Table -->
                <div class="bg-white p-5 md:p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold text-gray-900 border-b border-gray-200 pb-3 mb-4">Customize Yearly Plan</h2>
                    <div class="max-h-[600px] overflow-y-auto relative">
                        <table class="w-full min-w-[700px] text-left">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="p-3 font-semibold text-gray-600">Age</th>
                                    <th class="p-3 font-semibold text-gray-600">Year</th>
                                    <th class="p-3 font-semibold text-gray-600">Contribution (£/mo)</th>
                                    <th class="p-3 font-semibold text-gray-600">Withdrawal (£/yr)</th>
                                    <th class="p-3 font-semibold text-gray-600">Withdrawal (%)</th>
                                    <th class="p-3 font-semibold text-gray-600">Total Income (£/yr)</th>
                                </tr>
                            </thead>
                            <tbody id="yearlyPlanTable">
                                <!-- Rows will be generated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div> <!-- End Right Column -->

        </div> <!-- End Main Grid -->

        <!-- Yearly Plan Table -->
        <div class="bg-white p-5 md:p-6 rounded-xl shadow-lg hidden">
            <h2 class="text-xl font-bold text-gray-900 border-b border-gray-200 pb-3 mb-4">Customize Yearly Plan</h2>
            <div class="max-h-[600px] overflow-y-auto relative">
                <table class="w-full min-w-[700px] text-left">
                    <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th class="p-3 font-semibold text-gray-600">Age</th>
                            <th class="p-3 font-semibold text-gray-600">Year</th>
                            <th class="p-3 font-semibold text-gray-600">Contribution (£/mo)</th>
                            <th class="p-3 font-semibold text-gray-600">Withdrawal (£/yr)</th>
                            <th class="p-3 font-semibold text-gray-600">Withdrawal (%)</th>
                            <th class="p-3 font-semibold text-gray-600">Total Income (£/yr)</th>
                        </tr>
                    </thead>
                    <tbody id="yearlyPlanTable">
                        <!-- Rows will be generated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

    </div> <!-- End Main Content -->

    <script>
        // --- GLOBALS ---
        let pensionChart;
        let yearPlan = {};
        const MAX_AGE = 100;
        const NUM_SIMULATIONS = 1000;
        let currentChartMode = 'montecarlo'; // 'montecarlo' or 'single'

        // --- DOM ELEMENTS ---
        const $ = (id) => document.getElementById(id);

        // Inputs
        const inputs = {
            currentAge: $("currentAge"),
            retirementAge: $("retirementAge"),
            initialInvestment: $("initialInvestment"),
            defaultContribution: $("defaultContribution"),
            defaultWithdrawal: $("defaultWithdrawal"),
            defaultReturn: $("defaultReturn"),
            includeStatePension: $("includeStatePension"),
            statePensionAmount: $("statePensionAmount"),
            statePensionStartAge: $("statePensionStartAge"),
            runMonteCarlo: $("runMonteCarlo"),
            stockAllocation: $("stockAllocation"),
            investmentFee: $("investmentFee"),
            avgInflation: $("avgInflation"),
            stdDevInflation: $("stdDevInflation"),
            adjustForInflation: $("adjustForInflation"),
            stocksMean: $("stocksMean"),
            bondsMean: $("bondsMean"),
            stocksStdDev: $("stocksStdDev"),
            bondsStdDev: $("bondsStdDev"),
            correlation: $("correlation"),
        };

        // Value Displays
        const values = {
            currentAge: $("currentAgeValue"),
            retirementAge: $("retirementAgeValue"),
            defaultReturn: $("defaultReturnValue"),
            statePensionStartAge: $("statePensionStartAgeValue"),
            stockAllocation: $("stockAllocationValue"),
            bondAllocation: $("bondAllocationValue"),
            investmentFee: $("investmentFeeValue"),
            avgInflation: $("avgInflationValue"),
            stdDevInflation: $("stdDevInflationValue"),
        };

        // Containers
        const containers = {
            statePensionInputs: $("statePensionInputs"),
            monteCarloInputs: $("monteCarloInputs"),
            singleRunInputs: $("singleRunInputs"),
            yearlyPlanTable: $("yearlyPlanTable"),
            successRateBox: $("successRateBox"),
            stat1Label: $("stat1Label"),
            stat3Label: $("stat3Label"),
            simulationOverlay: $("simulationOverlay"),
            welcomeModal: $("welcomeModal"),
            welcomeModalContent: $("welcomeModalContent"),
            closeModalButton: $("closeModalButton"),
        };

        // Summary Stats
        const stats = {
            potAtRetirement: $("potAtRetirement"),
            planSuccessRate: $("planSuccessRate"),
            moneyRunsOutAge: $("moneyRunsOutAge"),
        };

        // --- STATISTICAL UTILITY ---
        
        /**
         * Generates a random number from a Lognormal distribution.
         * This is a more realistic model for financial returns than a normal distribution
         * as it doesn't produce values less than -100% and has "fatter tails".
         * @param {number} mean - The mean of the underlying normal distribution.
         * @param {number} stdDev - The standard deviation of the underlying normal distribution.
         * @returns {number} A random number from the lognormal distribution.
         */
        function getLognormalRandom(mean, stdDev) {
            // We need to convert the desired mean (mu) and std dev (sigma) of the *lognormal*
            // distribution into the mean (mu_norm) and std dev (sigma_norm) of the *underlying normal* distribution.
            
            // Note: The 'mean' and 'stdDev' parameters passed in are the *arithmetic* mean and std dev we desire, e.g., 8% and 16%.
            const mu = 1 + mean; // e.g., 1.08
            const sigma = stdDev; // e.g., 0.16

            // Formulas to find the parameters for the underlying normal distribution
            const mu_norm = Math.log(mu) - 0.5 * Math.log(1 + (sigma*sigma) / (mu*mu));
            const sigma_norm = Math.sqrt(Math.log(1 + (sigma*sigma) / (mu*mu)));

            // Use the Box-Muller transform to get a standard normal random number (mean 0, std dev 1)
            let u = 0, v = 0;
            while(u === 0) u = Math.random(); //Converting [0,1) to (0,1)
            while(v === 0) v = Math.random();
            const z = Math.sqrt( -2.0 * Math.log( u ) ) * Math.cos( 2.0 * Math.PI * v );

            // Scale the standard normal by the underlying normal's parameters and exponentiate
            const lognormalValue = Math.exp(mu_norm + z * sigma_norm);
            
            // Return the percentage change (e.g., 1.07 -> 0.07, 0.95 -> -0.05)
            return lognormalValue - 1;
        }


        /**
         * Generates correlated random numbers from two lognormal distributions (e.g., stocks and bonds).
         * @param {number} mean1 - Mean for the first asset (stocks)
         * @param {number} stdDev1 - Std Dev for the first asset (stocks)
         * @param {number} mean2 - Mean for the second asset (bonds)
         * @param {number} stdDev2 - Std Dev for the second asset (bonds)
         * @param {number} correlation - Correlation coefficient (-1 to 1)
         * @returns {{return1: number, return2: number}} Correlated returns
         */
        function getCorrelatedLognormalReturns(mean1, stdDev1, mean2, stdDev2, correlation) {
            // First, get two independent standard normal random variables (z1, z2)
            let u1 = 0, u2 = 0;
            while(u1 === 0) u1 = Math.random();
            while(u2 === 0) u2 = Math.random();
            const z1 = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
            const z2 = Math.sqrt(-2.0 * Math.log(u1)) * Math.sin(2.0 * Math.PI * u2);

            // Create two correlated standard normal variables (c1, c2)
            // c1 = z1
            // c2 = p*z1 + sqrt(1 - p^2) * z2
            const c1 = z1;
            const c2 = correlation * z1 + Math.sqrt(1 - correlation * correlation) * z2;

            // --- Convert desired Lognormal params to underlying Normal params ---
            // Asset 1 (Stocks)
            const mu1 = 1 + mean1;
            const sigma1 = stdDev1;
            const mu_norm1 = Math.log(mu1) - 0.5 * Math.log(1 + (sigma1*sigma1) / (mu1*mu1));
            const sigma_norm1 = Math.sqrt(Math.log(1 + (sigma1*sigma1) / (mu1*mu1)));
            
            // Asset 2 (Bonds)
            const mu2 = 1 + mean2;
            const sigma2 = stdDev2;
            const mu_norm2 = Math.log(mu2) - 0.5 * Math.log(1 + (sigma2*sigma2) / (mu2*mu2));
            const sigma_norm2 = Math.sqrt(Math.log(1 + (sigma2*sigma2) / (mu2*mu2)));

            // --- Apply correlated variables to underlying normal params and exponentiate ---
            const return1 = Math.exp(mu_norm1 + c1 * sigma_norm1) - 1;
            const return2 = Math.exp(mu_norm2 + c2 * sigma_norm2) - 1;

            return { return1, return2 };
        }
        
        /**
         * Calculates the percentile of a sorted array.
         * @param {number[]} sortedArray - A pre-sorted array of numbers.
         * @param {number} percentile - The percentile to calculate (0-100).
         * @returns {number} The value at that percentile.
         */
        function getPercentile(sortedArray, percentile) {
            if (sortedArray.length === 0) return 0;
            const index = (percentile / 100) * (sortedArray.length - 1);
            if (index % 1 === 0) {
                return sortedArray[index];
            }
            const lowerIndex = Math.floor(index);
            const upperIndex = Math.ceil(index);
            const weight = index - lowerIndex;
            return sortedArray[lowerIndex] * (1 - weight) + sortedArray[upperIndex] * weight;
        }

        // --- EVENT HANDLERS ---
        
        /**
         * Attaches all event listeners to UI elements.
         */
        function attachListeners() {
            // Attach listeners to all main inputs
            Object.keys(inputs).forEach(key => {
                const element = inputs[key];
                const eventType = (element.type === 'range' || element.type === 'checkbox') ? 'input' : 'change';
                element.addEventListener(eventType, handleInputChange);
            });

            // Special listener for table inputs (event delegation)
            containers.yearlyPlanTable.addEventListener('change', (e) => {
                if (e.target.tagName === 'INPUT') {
                    const age = parseInt(e.target.dataset.age);
                    const type = e.target.dataset.type;
                    const value = parseFloat(e.target.value) || 0;
                    
                    if (!yearPlan[age]) {
                        yearPlan[age] = {};
                    }
                    yearPlan[age][type] = value;
                    
                    // After updating yearPlan, recalculate
                    runSimulation();
                }
            });

            // Modal listeners
            containers.closeModalButton.addEventListener('click', closeModal);
            containers.welcomeModal.addEventListener('click', (e) => {
                if (e.target === containers.welcomeModal) {
                    closeModal();
                }
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                }
            });
        }
        
        /**
         * Handles changes from any of the main UI inputs.
         * Updates value displays and triggers a new simulation.
         * @param {Event} e - The input event.
         */
        function handleInputChange(e) {
            const id = e.target.id;
            let value = e.target.type === 'checkbox' ? e.target.checked : parseFloat(e.target.value);
            
            // Update linked value displays
            switch(id) {
                case 'currentAge':
                case 'retirementAge':
                    values[id].textContent = Math.round(value);
                    if (id === 'currentAge' && value >= parseFloat(inputs.retirementAge.value)) {
                        inputs.retirementAge.value = value + 1;
                        values.retirementAge.textContent = inputs.retirementAge.value;
                    }
                    if (id === 'retirementAge' && value <= parseFloat(inputs.currentAge.value)) {
                        inputs.currentAge.value = value - 1;
                        values.currentAge.textContent = inputs.currentAge.value;
                    }
                    // Re-generate the yearly table as ages have changed
                    generateYearlyPlanTable();
                    break;
                case 'defaultReturn':
                case 'avgInflation':
                case 'stdDevInflation':
                    values[id].textContent = value.toFixed(1);
                    break;
                case 'statePensionStartAge':
                    values[id].textContent = Math.round(value);
                    break;
                case 'investmentFee':
                    values[id].textContent = value.toFixed(2);
                    break;
                case 'stockAllocation':
                    values.stockAllocation.textContent = Math.round(value);
                    values.bondAllocation.textContent = 100 - Math.round(value);
                    break;
                case 'includeStatePension':
                    containers.statePensionInputs.classList.toggle('hidden', !value);
                    break;
                case 'runMonteCarlo':
                    toggleChartMode(value);
                    break;
            }
            
            // Re-run the simulation
            runSimulation();
        }

        // --- MODAL & UI LOGIC ---

        /**
         * Shows the welcome modal.
         */
        function showModal() {
            containers.welcomeModal.classList.remove('opacity-0', 'pointer-events-none');
            containers.welcomeModalContent.classList.remove('scale-95', 'opacity-0');
        }

        /**
         * Hides the welcome modal and saves preference.
         */
        function closeModal() {
            containers.welcomeModal.classList.add('opacity-0', 'pointer-events-none');
            containers.welcomeModalContent.classList.add('scale-95', 'opacity-0');
            // Use localStorage to not show again
            try {
                localStorage.setItem('pensionForecasterVisited', 'true');
            } catch (e) {
                console.warn("Could not save to localStorage.");
            }
        }
        
        /**
         * Toggles the UI between single run and Monte Carlo mode.
         * @param {boolean} isMonteCarlo - True to show Monte Carlo, false for single run.
         */
        function toggleChartMode(isMonteCarlo) {
            containers.monteCarloInputs.classList.toggle('hidden', !isMonteCarlo);
            containers.singleRunInputs.classList.toggle('hidden', isMonteCarlo);
            containers.successRateBox.classList.toggle('hidden', !isMonteCarlo);
            
            currentChartMode = isMonteCarlo ? 'montecarlo' : 'single';

            // Update labels
            if (isMonteCarlo) {
                containers.stat1Label.textContent = "Median Pot at Retirement";
                containers.stat3Label.textContent = "Median Runs Out Age";
            } else {
                containers.stat1Label.textContent = "Pot at Retirement";
                containers.stat3Label.textContent = "Pot Runs Out Age";
            }
        }
        
        /**
         * Shows or hides the "Simulating..." overlay.
         * @param {boolean} show - True to show, false to hide.
         */
        function showSimulationOverlay(show) {
            if (show) {
                containers.simulationOverlay.classList.remove('opacity-0', 'pointer-events-none');
            } else {
                containers.simulationOverlay.classList.add('opacity-0', 'pointer-events-none');
            }
        }

        // --- CHARTING LOGIC ---

        /**
         * Initializes the Chart.js chart.
         */
        function initChart() {
            const ctx = $('pensionChart').getContext('2d');
            pensionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [], // Ages
                    datasets: [
                        {
                            label: '90th Percentile (Good)',
                            data: [],
                            borderColor: 'rgba(56, 189, 248, 0.4)', // gem-blue-400 with alpha
                            backgroundColor: 'rgba(56, 189, 248, 0.2)', // gem-blue-400 with alpha
                            borderWidth: 1.5,
                            pointRadius: 0,
                            fill: '+1', // Fill to next dataset (10th)
                            tension: 0.1
                        },
                        {
                            label: '10th Percentile (Poor)',
                            data: [],
                            borderColor: 'rgba(56, 189, 248, 0.4)', // gem-blue-400 with alpha
                            backgroundColor: 'rgba(56, 189, 248, 0.2)', // gem-blue-400 with alpha
                            borderWidth: 1.5,
                            pointRadius: 0,
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: '50th Percentile (Median)',
                            data: [],
                            borderColor: '#1f2937', // gray-800
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Pension Pot Value',
                            data: [],
                            borderColor: '#0284c7', // gem-blue-600
                            backgroundColor: 'rgba(2, 132, 199, 0.1)',
                            borderWidth: 3,
                            pointRadius: 0,
                            fill: 'origin',
                            tension: 0.1
                        },
                        {
                            label: 'Total Annual Income',
                            data: [],
                            backgroundColor: 'rgba(2, 132, 199, 0.6)', // gem-blue-600 with alpha
                            borderColor: 'rgba(2, 132, 199, 0.8)',
                            type: 'bar',
                            yAxisID: 'y1',
                            barPercentage: 0.8,
                            categoryPercentage: 0.8,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    aspectRatio: 1.7,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                boxWidth: 10,
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', maximumFractionDigits: 0 }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Age',
                                font: {
                                    weight: 'bold'
                                }
                            }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Pension Pot Value (£)',
                                font: {
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                callback: function(value, index, values) {
                                    return '£' + (value / 1000) + 'k';
                                }
                            },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Annual Income (£)',
                                font: {
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                callback: function(value, index, values) {
                                    return '£' + (value / 1000) + 'k';
                                }
                            },
                            grid: {
                                drawOnChartArea: false, // Only draw grid for left axis
                            },
                            beginAtZero: true
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    }
                }
            });
        }
        
        /**
         * Updates the chart with new data from a simulation.
         * @param {Object} results - The processed results from the simulation.
         */
        function updateChart(results) {
            pensionChart.data.labels = results.labels;

            const isMonteCarlo = currentChartMode === 'montecarlo';
            
            // Toggle visibility of Monte Carlo datasets (Percentiles)
            pensionChart.data.datasets[0].data = isMonteCarlo ? results.percentiles.p90 : [];
            pensionChart.data.datasets[1].data = isMonteCarlo ? results.percentiles.p10 : [];
            pensionChart.data.datasets[2].data = isMonteCarlo ? results.percentiles.p50 : [];
            
            // Toggle visibility of Single Run dataset
            pensionChart.data.datasets[3].data = !isMonteCarlo ? results.percentiles.p50 : []; // Use p50 as it holds the single run

            // Update Income Bars (uses p50 for both modes)
            pensionChart.data.datasets[4].data = results.percentiles.p50_income;

            // Dynamically set visibility in options (a more robust way)
            pensionChart.setDatasetVisibility(0, isMonteCarlo); // 90th
            pensionChart.setDatasetVisibility(1, isMonteCarlo); // 10th
            pensionChart.setDatasetVisibility(2, isMonteCarlo); // 50th
            pensionChart.setDatasetVisibility(3, !isMonteCarlo); // Single Run
            
            pensionChart.update();
        }

        // --- YEARLY PLAN TABLE ---

        /**
         * Generates the rows for the "Customize Yearly Plan" table.
         */
        function generateYearlyPlanTable() {
            let html = '';
            const cAge = parseInt(inputs.currentAge.value);
            const rAge = parseInt(inputs.retirementAge.value);
            
            for (let age = cAge; age <= MAX_AGE; age++) {
                const year = new Date().getFullYear() + (age - cAge);
                const isRetired = age >= rAge;
                
                // Get custom values from yearPlan or use defaults
                const customContribution = yearPlan[age]?.contribution ?? '';
                const customWithdrawal = yearPlan[age]?.withdrawal ?? '';

                html += `<tr class="border-b border-gray-200 ${isRetired ? 'bg-gem-blue-50' : 'bg-white'} hover:bg-gray-50">
                    <td class="p-2 font-semibold">${age}</td>
                    <td class="p-2 text-gray-600">${year}</td>
                    <td class="p-2">
                        <input type="number" data-age="${age}" data-type="contribution" placeholder="${isRetired ? 'N/A' : inputs.defaultContribution.value}" 
                               class="w-full p-2 text-sm rounded-md border border-gray-300 focus:outline-none focus:ring-1 focus:ring-gem-blue-500" 
                               ${isRetired ? 'disabled' : ''} value="${customContribution}">
                    </td>
                    <td class="p-2">
                        <input type="number" data-age="${age}" data-type="withdrawal" placeholder="${!isRetired ? 'N/A' : inputs.defaultWithdrawal.value}" 
                               class="w-full p-2 text-sm rounded-md border border-gray-300 focus:outline-none focus:ring-1 focus:ring-gem-blue-500" 
                               ${!isRetired ? 'disabled' : ''} value="${customWithdrawal}">
                    </td>
                    <td class="p-2 text-sm font-medium text-gray-700">
                        <span id="withdrawal-pct-${age}">-</span>
                    </td>
                    <td class="p-2 text-sm font-semibold text-gem-blue-800">
                        <span id="total-income-${age}">-</span>
                    </td>
                </tr>`;
            }
            containers.yearlyPlanTable.innerHTML = html;
        }
        
        /**
         * Updates the dynamic columns in the yearly plan table (Withdrawal % and Total Income).
         * @param {Object} results - The processed simulation results (uses median).
         */
        function updateYearlyPlanTable(results) {
            const cAge = parseInt(inputs.currentAge.value);
            const rAge = parseInt(inputs.retirementAge.value);
            
            for (let i = 0; i < results.labels.length; i++) {
                const age = results.labels[i];
                const potValue = results.percentiles.p50[i] ?? 0;
                const medianTotalIncome = results.percentiles.p50_income[i] ?? 0;
                
                let withdrawalPct = 0;
                let displayIncome = '-';

                if (age >= rAge) {
                    // Use the base planned withdrawal for the % calculation
                    const baseWithdrawalAmount = parseFloat(yearPlan[age]?.withdrawal) || parseFloat(inputs.defaultWithdrawal.value);
                    
                    if (potValue > 0) {
                        withdrawalPct = (baseWithdrawalAmount / potValue) * 100;
                    }
                    
                    // Use the median *simulated* income for the total income display
                    if (medianTotalIncome > 0) {
                        displayIncome = `£${Math.round(medianTotalIncome).toLocaleString()}`;
                    }
                }
                
                const pctEl = $(`withdrawal-pct-${age}`);
                const incomeEl = $(`total-income-${age}`);
                
                if (pctEl) {
                    pctEl.textContent = (age >= rAge && potValue > 0 && isFinite(withdrawalPct)) ? `${withdrawalPct.toFixed(1)}%` : '-';
                }
                if (incomeEl) {
                    incomeEl.textContent = displayIncome;
                }
            }
        }


        // --- SIMULATION LOGIC ---

        /**
         * Main function to trigger a new simulation.
         * Debounced to prevent excessive runs on slider drag.
         */
        let simulationTimeout;
        function runSimulation() {
            clearTimeout(simulationTimeout);
            simulationTimeout = setTimeout(() => {
                const isMonteCarlo = inputs.runMonteCarlo.checked;
                let results;
                
                if (isMonteCarlo) {
                    // Show overlay only for the heavy simulation
                    showSimulationOverlay(true);
                    // Use setTimeout to allow UI to update before blocking
                    setTimeout(() => {
                        results = runMonteCarloSimulation();
                        processAndDisplayResults(results);
                        showSimulationOverlay(false);
                    }, 50); // 50ms delay
                } else {
                    results = runSingleSimulation();
                    processAndDisplayResults(results);
                }
            }, 250); // 250ms debounce
        }

        /**
         * Gathers all settings from the UI.
         * @returns {Object} A settings object.
         */
        function getSettings() {
            const settings = {};
            for (const key in inputs) {
                settings[key] = inputs[key].type === 'checkbox' ? inputs[key].checked : (parseFloat(inputs[key].value) || 0);
            }
            
            // Convert percentages to decimals for calculation
            settings.defaultReturn /= 100;
            settings.avgInflation /= 100;
            settings.stdDevInflation /= 100;
            settings.investmentFee /= 100;
            settings.stockAllocation /= 100;
            
            settings.stocksMean /= 100;
            settings.stocksStdDev /= 100;
            settings.bondsMean /= 100;
            settings.bondsStdDev /= 100;
            
            return settings;
        }
        
        /**
         * Runs a single simulation run (either deterministic or one random walk).
         * @param {Object} settings - The settings object.
         * @returns {Object} An object containing the simulation results for one run.
         */
        function calculateSingleRun(settings) {
            const { currentAge, retirementAge, initialInvestment, defaultContribution, defaultWithdrawal, defaultReturn, 
                    includeStatePension, statePensionAmount, statePensionStartAge,
                    runMonteCarlo, stockAllocation, investmentFee, avgInflation, stdDevInflation, adjustForInflation,
                    stocksMean, stocksStdDev, bondsMean, bondsStdDev, correlation } = settings;

            let pot = initialInvestment;
            let cumulativeInflation = 1.0;
            
            const potValues = [];
            const incomeValues = [];
            
            for (let age = currentAge; age <= MAX_AGE; age++) {
                let annualReturn = 0;
                let annualInflation = 0;
                
                if (runMonteCarlo) {
                    // --- Stochastic (Monte Carlo) Run ---
                    // Get correlated returns for stocks and bonds
                    const { return1: stockReturn, return2: bondReturn } = getCorrelatedLognormalReturns(
                        stocksMean, stocksStdDev, bondsMean, bondsStdDev, correlation
                    );
                    
                    // Calculate portfolio return based on allocation
                    const portfolioReturn = (stockReturn * stockAllocation) + (bondReturn * (1.0 - stockAllocation));
                    
                    // Subtract fees
                    annualReturn = portfolioReturn - investmentFee;
                    
                    // Get random inflation
                    annualInflation = getLognormalRandom(avgInflation, stdDevInflation);
                } else {
                    // --- Deterministic (Single) Run ---
                    annualReturn = defaultReturn;
                    // No inflation in single run mode (for simplicity, could be added)
                    annualInflation = 0;
                }

                let contribution = 0;
                let withdrawal = 0;
                let annualIncome = 0;

                if (age < retirementAge) {
                    // --- Accumulation Phase ---
                    contribution = (yearPlan[age]?.contribution ?? defaultContribution) * 12;
                    pot += contribution;
                } else {
                    // --- Decumulation (Retirement) Phase ---
                    let baseWithdrawal = yearPlan[age]?.withdrawal ?? defaultWithdrawal;
                    
                    if (runMonteCarlo && adjustForInflation) {
                        // Adjust the user's *planned* withdrawal for this year by cumulative inflation
                        withdrawal = baseWithdrawal * cumulativeInflation;
                    } else {
                        withdrawal = baseWithdrawal;
                    }
                    
                    // Don't withdraw more than the pot
                    withdrawal = Math.min(pot, withdrawal);
                    pot -= withdrawal;
                    
                    annualIncome = withdrawal;
                    if (includeStatePension && age >= statePensionStartAge) {
                        // State pension is assumed to be inflation-linked, so we use the cumulative inflation factor
                        let currentYearStatePension = statePensionAmount;
                        if (runMonteCarlo && adjustForInflation) {
                            currentYearStatePension *= cumulativeInflation;
                        }
                        annualIncome += currentYearStatePension;
                    }
                }
                
                // Apply gains
                pot = Math.max(0, pot * (1 + annualReturn));

                // Update cumulative inflation for next year
                cumulativeInflation *= (1 + annualInflation);
                
                potValues.push(pot);
                incomeValues.push(annualIncome);
                
                if (pot === 0 && age >= retirementAge) {
                    // Pot is empty, fill rest of array with 0 and break
                    for (let i = age + 1; i <= MAX_AGE; i++) {
                        potValues.push(0);
                        // Income may still exist (state pension)
                        let futureIncome = 0;
                        if (includeStatePension && i >= statePensionStartAge) {
                             let futureStatePension = statePensionAmount;
                             if(runMonteCarlo && adjustForInflation) {
                                // Continue to inflate state pension
                                cumulativeInflation *= (1 + getLognormalRandom(avgInflation, stdDevInflation));
                                futureStatePension *= cumulativeInflation;
                             }
                             futureIncome = futureStatePension;
                        }
                        incomeValues.push(futureIncome);
                    }
                    break; // Exit loop, this run is done
                }
            }
            return { potValues, incomeValues };
        }
        
        /**
         * Runs the full Monte Carlo simulation (1000 runs).
         * @returns {Object} An object containing labels and all simulation run data.
         */
        function runMonteCarloSimulation() {
            const settings = getSettings();
            const { currentAge } = settings;
            
            const allSimulations = {
                pot: [],
                income: []
            };
            const labels = [];
            
            for (let age = currentAge; age <= MAX_AGE; age++) {
                labels.push(age);
                // Create an array to hold all 1000 values for this specific age
                allSimulations.pot.push([]);
                allSimulations.income.push([]);
            }
            
            for (let i = 0; i < NUM_SIMULATIONS; i++) {
                const run = calculateSingleRun(settings);
                for (let j = 0; j < run.potValues.length; j++) {
                    if (allSimulations.pot[j]) {
                        allSimulations.pot[j].push(run.potValues[j]);
                    }
                    if (allSimulations.income[j]) {
                        allSimulations.income[j].push(run.incomeValues[j]);
                    }
                }
            }
            
            return { labels, allSimulations };
        }
        
        /**
         * Runs a single deterministic simulation.
         * @returns {Object} An object containing labels and a single simulation run.
         */
        function runSingleSimulation() {
            const settings = getSettings();
            const { currentAge } = settings;
            
            const allSimulations = {
                pot: [],
                income: []
            };
            const labels = [];
            
            const run = calculateSingleRun(settings);
            
            for (let age = currentAge; age <= MAX_AGE; age++) {
                labels.push(age);
                const ageIndex = age - currentAge;
                allSimulations.pot.push([run.potValues[ageIndex] ?? 0]);
                allSimulations.income.push([run.incomeValues[ageIndex] ?? 0]);
            }
            
            return { labels, allSimulations };
        }

        // --- RESULT PROCESSING ---

        /**
         * Processes the raw simulation data into percentiles and summary stats.
         * @param {Object} results - The raw results from the simulation functions.
         * @returns {Object} The processed results.
         */
        function processSimulationResults(results) {
            const { labels, allSimulations } = results;
            const settings = getSettings();
            
            const percentiles = {
                p10: [],
                p50: [],
                p90: [],
                p50_income: []
            };
            
            let successRuns = 0;
            const runsOutAges = [];

            // Calculate percentiles for each year
            for (let i = 0; i < allSimulations.pot.length; i++) {
                const sortedPotYear = [...allSimulations.pot[i]].sort((a, b) => a - b);
                const sortedIncomeYear = [...allSimulations.income[i]].sort((a, b) => a - b);
                
                percentiles.p10.push(getPercentile(sortedPotYear, 10));
                percentiles.p50.push(getPercentile(sortedPotYear, 50));
                percentiles.p90.push(getPercentile(sortedPotYear, 90));
                percentiles.p50_income.push(getPercentile(sortedIncomeYear, 50));
            }
            
            // Calculate summary stats (Success Rate, Runs Out Age)
            const numRuns = allSimulations.pot[0].length; // e.g., 1000 or 1
            const retirementIndex = settings.retirementAge - settings.currentAge;
            const lastIndex = labels.length - 1;

            for (let i = 0; i < numRuns; i++) {
                let runsOutAge = "N/A";
                let succeeded = true;
                
                // Check if pot is empty at the end
                if (allSimulations.pot[lastIndex][i] === 0) {
                    succeeded = false;
                    // Find when it first hit 0 *after* retirement
                    for (let j = retirementIndex; j <= lastIndex; j++) {
                        if (allSimulations.pot[j][i] === 0) {
                            runsOutAge = labels[j]; // Age
                            break;
                        }
                    }
                }
                
                if (succeeded) {
                    successRuns++;
                }
                if (runsOutAge !== "N/A") {
                    runsOutAges.push(runsOutAge);
                }
            }
            
            const summary = {
                potAtRetirement: percentiles.p50[retirementIndex] ?? 0,
                planSuccessRate: (successRuns / numRuns) * 100,
                moneyRunsOutAge: "N/A"
            };
            
            if (runsOutAges.length > 0) {
                runsOutAges.sort((a, b) => a - b);
                summary.moneyRunsOutAge = getPercentile(runsOutAges, 50); // Median runs out age
            }
            
            // For single run, simplify stats
            if (numRuns === 1) {
                summary.planSuccessRate = (summary.moneyRunsOutAge === "N/A") ? 100 : 0;
                if (summary.planSuccessRate === 100) {
                     summary.moneyRunsOutAge = "N/A";
                } else {
                     summary.moneyRunsOutAge = runsOutAges[0];
                }
            }

            return { labels, percentiles, summary };
        }
        
        /**
         * Updates the UI (stats, chart, table) with processed results.
         * @param {Object} rawResults - The raw simulation data.
         */
        function processAndDisplayResults(rawResults) {
            const processedResults = processSimulationResults(rawResults);
            
            // 1. Update Summary Stats
            stats.potAtRetirement.textContent = `£${Math.round(processedResults.summary.potAtRetirement).toLocaleString()}`;
            stats.planSuccessRate.textContent = `${processedResults.summary.planSuccessRate.toFixed(0)}%`;
            stats.moneyRunsOutAge.textContent = processedResults.summary.moneyRunsOutAge;
            
            // 2. Update Chart
            updateChart(processedResults);
            
            // 3. Update dynamic table columns
            updateYearlyPlanTable(processedResults);
        }

        // --- INITIALIZATION ---

        /**
         * Main initialization function.
         */
        function initialize() {
            // Check if user has visited before
            let visited = false;
            try {
                visited = localStorage.getItem('pensionForecasterVisited') === 'true';
            } catch (e) {
                console.warn("Could not read from localStorage.");
            }

            if (!visited) {
                showModal();
            } else {
                containers.welcomeModal.classList.add('opacity-0', 'pointer-events-none');
                containers.welcomeModal.classList.add('hidden'); // Hide completely if visited
            }

            initChart();
            generateYearlyPlanTable();
            attachListeners();
            
            // Set initial UI state
            toggleChartMode(inputs.runMonteCarlo.checked);
            containers.statePensionInputs.classList.toggle('hidden', !inputs.includeStatePension.checked);
            
            // Trigger initial value display updates
            const initialEvent = new Event('input');
            const changeEvent = new Event('change');
            Object.keys(inputs).forEach(key => {
                if(inputs[key].type === 'range') inputs[key].dispatchEvent(initialEvent);
                if(inputs[key].type === 'number') inputs[key].dispatchEvent(changeEvent);
            });
        }
        
        // Start the application once the DOM is ready
        document.addEventListener('DOMContentLoaded', initialize);

    </script>
</body>
</html>



